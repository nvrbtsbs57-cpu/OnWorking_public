<!doctype html>
<html lang="fr" class="theme-dark">
<head>
  <meta charset="utf-8" />
  <title>BOT GODMODE ‚Äì Dashboard runtime</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />

  <style>
    /* -------------------------------------------------------------
     * RESET LIGHT
     * ------------------------------------------------------------- */
    * {
      box-sizing: border-box;
      margin: 0;
      padding: 0;
    }
    html, body {
      height: 100%;
    }
    body {
      font-family: system-ui, -apple-system, BlinkMacSystemFont, "SF Pro Text",
        "Segoe UI", sans-serif;
      background: #020617;
      color: #e5e7eb;
      -webkit-font-smoothing: antialiased;
    }
    button {
      font: inherit;
      border: none;
      cursor: pointer;
      background: none;
      color: inherit;
    }

    /* -------------------------------------------------------------
     * BACKGROUND + LAYOUT
     * ------------------------------------------------------------- */

    .page {
      position: relative;
      min-height: 100vh;
      overflow: hidden;
    }

    /* Photo BTC de fond */
    .page-bg {
      position: fixed;
      inset: 0;
      background-image: url("godmode/btc_bg.jpg");
      background-size: cover;
      background-position: center;
      filter: blur(2px);
      transform: scale(1.03);
      z-index: -2;
    }

    /* Voile sombre + halo dor√© (sans bleu) */
    .page-overlay {
      position: fixed;
      inset: 0;
      background:
        radial-gradient(circle at top left, rgba(254, 215, 170, 0.35), transparent 55%),
        radial-gradient(circle at bottom right, rgba(251, 146, 60, 0.35), transparent 55%),
        linear-gradient(to bottom, rgba(0, 0, 0, 0.78), rgba(0, 0, 0, 0.94));
      z-index: -1;
    }

    .page-inner {
      max-width: 1440px;
      margin: 0 auto;
      padding: 20px 18px 36px;
    }

    /* Bloc principal ‚Äúverre fum√©‚Äù au centre */
    .dashboard-frame {
      width: 100%;
      max-width: 1440px;
      border-radius: 24px;
      padding: 20px 20px 24px;

      /* üî• tr√®s l√©ger voile noir, plus de fond bleu */
      background: rgba(0, 0, 0, 0.10);
      backdrop-filter: blur(4px);

      border: 1px solid rgba(252, 211, 77, 0.7);
      box-shadow:
        0 0 0 1px rgba(0, 0, 0, 0.85) inset,
        0 0 40px rgba(250, 204, 21, 0.35);
    }

    /* -------------------------------------------------------------
     * HEADER
     * ------------------------------------------------------------- */

    .topbar {
      display: flex;
      flex-wrap: wrap;
      align-items: center;
      justify-content: space-between;
      gap: 12px;
      margin-bottom: 12px;
    }

    .topbar-left {
      display: flex;
      align-items: center;
      gap: 10px;
    }

    .logo-dot {
      width: 10px;
      height: 10px;
      border-radius: 999px;
      background: radial-gradient(circle at 30% 30%, #facc15, #f97316);
      box-shadow: 0 0 14px rgba(251, 191, 36, 0.9);
    }

    .title-main {
      font-size: 20px;
      font-weight: 700;
      letter-spacing: 0.06em;
      text-transform: uppercase;
    }

    .badge {
      display: inline-flex;
      align-items: center;
      gap: 6px;
      border-radius: 999px;
      padding: 3px 10px;
      font-size: 11px;
      text-transform: uppercase;
      letter-spacing: 0.08em;
      border: 1px solid rgba(250, 204, 21, 0.7);
      background: radial-gradient(circle at top left,
        rgba(251, 191, 36, 0.4),
        rgba(23, 23, 23, 0.9));
      box-shadow: 0 0 16px rgba(250, 204, 21, 0.45);
    }

    .badge-pill {
      font-size: 11px;
      border-radius: 999px;
      padding: 3px 10px;
      border: 1px solid rgba(148, 163, 184, 0.6);
      background: rgba(15, 23, 42, 0.75);
    }

    .topbar-right {
      display: flex;
      flex-wrap: wrap;
      align-items: center;
      gap: 10px;
      font-size: 11px;
      color: #9ca3af;
    }

    .topbar-right small {
      opacity: 0.85;
    }

    .refresh-row {
      display: flex;
      align-items: center;
      gap: 8px;
    }

    .btn-refresh-main {
      display: inline-flex;
      align-items: center;
      gap: 8px;
      padding: 4px 10px;
      border-radius: 999px;
      background: radial-gradient(circle at top left,
        rgba(34, 197, 94, 0.18),
        rgba(15, 23, 42, 0.95));
      border: 1px solid rgba(74, 222, 128, 0.6);
      font-size: 12px;
      color: #bbf7d0;
      box-shadow: 0 0 18px rgba(34, 197, 94, 0.45);
    }

    .btn-refresh-main-icon {
      width: 15px;
      height: 15px;
      border-radius: 999px;
      border: 2px solid rgba(74, 222, 128, 0.8);
      border-top-color: transparent;
      animation: spin 1s linear infinite;
    }

    .btn-pill {
      border-radius: 999px;
      padding: 3px 9px;
      font-size: 11px;
      border: 1px solid rgba(148, 163, 184, 0.8);
      background: rgba(15, 23, 42, 0.82);
      color: #e5e7eb;
      opacity: 0.85;
    }

    .btn-pill.active {
      border-color: rgba(250, 204, 21, 0.9);
      background: radial-gradient(circle at top left,
        rgba(250, 204, 21, 0.6),
        rgba(30, 64, 175, 0.05));
      color: #fef9c3;
      box-shadow: 0 0 18px rgba(250, 204, 21, 0.55);
      opacity: 1;
    }

    @keyframes spin {
      to { transform: rotate(360deg); }
    }

    /* -------------------------------------------------------------
     * HEADER METRICS
     * ------------------------------------------------------------- */

    .header-metrics {
      display: grid;
      grid-template-columns: repeat(3, minmax(0, 1fr));
      gap: 10px;
      margin-bottom: 14px;
      font-size: 12px;
    }

    .metric-main {
      position: relative;
      padding: 10px 12px;
      border-radius: 14px;
      border: 1px solid rgba(251, 191, 36, 0.7);
      background: radial-gradient(circle at top left,
        rgba(251, 191, 36, 0.35),
        rgba(15, 23, 42, 0.96));
      box-shadow: 0 0 24px rgba(250, 204, 21, 0.55);
    }

    .metric-main-label {
      font-size: 11px;
      text-transform: uppercase;
      letter-spacing: 0.09em;
      color: #fef3c7;
      opacity: 0.9;
    }

    .metric-main-value {
      margin-top: 4px;
      font-size: 20px;
      font-weight: 700;
      color: #fef9c3;
    }

    .metric-secondary {
      position: relative;
      padding: 10px 12px;
      border-radius: 14px;
      border: 1px solid rgba(148, 163, 184, 0.7);
      background: rgba(15, 23, 42, 0.85);
      box-shadow: 0 0 18px rgba(15, 23, 42, 0.95);
    }

    .metric-secondary-label {
      font-size: 11px;
      text-transform: uppercase;
      letter-spacing: 0.09em;
      color: #9ca3af;
      opacity: 0.95;
    }

    .metric-secondary-value {
      margin-top: 4px;
      font-size: 17px;
      font-weight: 600;
      color: #e5e7eb;
    }

    .live-indicator {
      display: inline-flex;
      align-items: center;
      gap: 8px;
    }
    .live-dot {
      width: 9px;
      height: 9px;
      border-radius: 999px;
      box-shadow: 0 0 8px rgba(248, 113, 113, 0.8);
    }
    .live-dot.off {
      background: radial-gradient(circle at 30% 30%, #f87171, #7f1d1d);
      box-shadow: 0 0 10px rgba(248, 113, 113, 0.85);
    }
    .live-dot.on {
      background: radial-gradient(circle at 30% 30%, #22c55e, #14532d);
      box-shadow: 0 0 12px rgba(34, 197, 94, 0.9);
    }
    .live-label {
      font-size: 12px;
    }

    .header-subline {
      margin-top: 6px;
      font-size: 11px;
      color: #9ca3af;
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 8px;
    }

    /* -------------------------------------------------------------
     * GRID PRINCIPALE
     * ------------------------------------------------------------- */

    .grid-main {
      display: grid;
      grid-template-columns: minmax(0, 1.9fr) minmax(0, 1.3fr);
      gap: 12px;
      margin-top: 14px;
    }

    .grid-col {
      display: flex;
      flex-direction: column;
      gap: 12px;
    }

    .card {
      position: relative;
      padding: 12px 13px 14px;
      border-radius: 16px;
      border: 1px solid rgba(148, 163, 184, 0.8);
      /* üî• noir fum√©, plus de radial bleu */
      background: rgba(0, 0, 0, 0.78);
      box-shadow:
        0 0 0 1px rgba(0, 0, 0, 0.9) inset,
        0 12px 24px rgba(0, 0, 0, 0.95);
    }

    .card-header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 8px;
      margin-bottom: 8px;
    }

    .card-title {
      font-size: 12px;
      text-transform: uppercase;
      letter-spacing: 0.1em;
      color: #e5e7eb;
    }

    .card-subtitle {
      font-size: 11px;
      color: #9ca3af;
    }

    .pill-small {
      border-radius: 999px;
      padding: 2px 8px;
      font-size: 10px;
      border: 1px solid rgba(148, 163, 184, 0.7);
      background: rgba(15, 23, 42, 0.85);
      color: #cbd5f5;
    }

    .pill-live-off {
      border-color: rgba(248, 113, 113, 0.9);
      color: #fecaca;
      background: radial-gradient(circle at top left,
        rgba(248, 113, 113, 0.4),
        rgba(15, 23, 42, 0.95));
      box-shadow: 0 0 14px rgba(248, 113, 113, 0.65);
    }

    .pill-killswitch-ok {
      border-color: rgba(34, 197, 94, 0.9);
      color: #bbf7d0;
      background: radial-gradient(circle at top left,
        rgba(34, 197, 94, 0.36),
        rgba(15, 23, 42, 0.95));
      box-shadow: 0 0 14px rgba(34, 197, 94, 0.65);
    }

    .badge-count {
      border-radius: 999px;
      padding: 2px 8px;
      font-size: 11px;
      border: 1px solid rgba(148, 163, 184, 0.7);
      background: rgba(15, 23, 42, 0.9);
      color: #e5e7eb;
    }

    .muted {
      opacity: 0.8;
      font-size: 11px;
      color: #9ca3af;
    }

    .status-json {
      font-family: "SF Mono", ui-monospace, Menlo, Monaco, Consolas,
        "Liberation Mono", "Courier New", monospace;
      font-size: 11px;
      line-height: 1.4;
      background: rgba(15, 23, 42, 0.95);
      border-radius: 10px;
      border: 1px solid rgba(55, 65, 81, 0.9);
      padding: 10px;
      max-height: 220px;
      overflow: auto;
      color: #e5e7eb;
    }

    .status-footer {
      margin-top: 6px;
      display: flex;
      justify-content: space-between;
      align-items: center;
      font-size: 11px;
      color: #9ca3af;
      gap: 8px;
    }

    .status-bar {
      flex: 1;
      height: 4px;
      border-radius: 999px;
      background: linear-gradient(to right,
        rgba(34, 197, 94, 0.2),
        rgba(234, 179, 8, 0.7),
        rgba(248, 113, 113, 0.9));
      overflow: hidden;
    }

    /* -------------------------------------------------------------
     * TABLES
     * ------------------------------------------------------------- */

    table {
      width: 100%;
      border-collapse: collapse;
      font-size: 11px;
    }

    thead {
      background: radial-gradient(circle at top left,
        rgba(31, 41, 55, 0.95),
        rgba(15, 23, 42, 0.98));
    }

    th, td {
      padding: 5px 6px;
      text-align: left;
      white-space: nowrap;
    }

    th {
      font-weight: 500;
      text-transform: uppercase;
      letter-spacing: 0.08em;
      font-size: 10px;
      color: #9ca3af;
      border-bottom: 1px solid rgba(55, 65, 81, 0.9);
    }

    tbody tr:nth-child(odd) td {
      background: rgba(15, 23, 42, 0.88);
    }

    tbody tr:nth-child(even) td {
      background: rgba(17, 24, 39, 0.95);
    }

    tbody tr:hover td {
      background: rgba(30, 64, 175, 0.45);
    }

    .td-right {
      text-align: right;
    }

    .td-center {
      text-align: center;
    }

    .tag-side-buy {
      display: inline-flex;
      padding: 1px 7px;
      border-radius: 999px;
      font-size: 10px;
      border: 1px solid rgba(34, 197, 94, 0.9);
      color: #bbf7d0;
      background: rgba(22, 101, 52, 0.85);
    }

    .tag-side-sell {
      display: inline-flex;
      padding: 1px 7px;
      border-radius: 999px;
      font-size: 10px;
      border: 1px solid rgba(248, 113, 113, 0.9);
      color: #fecaca;
      background: rgba(127, 29, 29, 0.85);
    }

    /* -------------------------------------------------------------
     * WALLETS
     * ------------------------------------------------------------- */

    .wallets-footer {
      margin-top: 6px;
      font-size: 11px;
      color: #9ca3af;
    }

    .wallets-footer strong {
      color: #facc15;
      font-weight: 600;
    }

    /* -------------------------------------------------------------
     * STAT JOUR PnL PAR TRADE
     * ------------------------------------------------------------- */

    .daily-grid {
      display: grid;
      grid-template-columns: repeat(4, minmax(0, 1fr));
      gap: 8px;
      margin-top: 6px;
    }

    .daily-item {
      padding: 7px 8px;
      border-radius: 10px;
      background: rgba(15, 23, 42, 0.96);
      border: 1px solid rgba(55, 65, 81, 0.9);
    }

    .daily-label {
      font-size: 10px;
      text-transform: uppercase;
      letter-spacing: 0.08em;
      color: #9ca3af;
    }

    .daily-value {
      margin-top: 2px;
      font-size: 13px;
      font-weight: 500;
      color: #e5e7eb;
    }

    .daily-value.positive {
      color: #bbf7d0;
    }

    .daily-value.negative {
      color: #fecaca;
    }

    /* -------------------------------------------------------------
     * ALERTES FINANCE
     * ------------------------------------------------------------- */

    .alerts-list {
      margin-top: 4px;
      font-size: 11px;
      max-height: 210px;
      overflow: auto;
    }

    .alert-item {
      padding: 6px 7px;
      border-radius: 9px;
      margin-bottom: 4px;
      border: 1px solid rgba(55, 65, 81, 0.8);
    }

    .alert-lvl-warning {
      border-color: rgba(250, 204, 21, 0.8);
      background: rgba(113, 63, 18, 0.7);
      color: #fef3c7;
    }

    .alert-lvl-critical {
      border-color: rgba(248, 113, 113, 0.9);
      background: rgba(127, 29, 29, 0.85);
      color: #fee2e2;
    }

    .alert-code {
      font-weight: 600;
      font-size: 11px;
    }

    .alert-msg {
      margin-top: 2px;
    }

    .alert-meta {
      margin-top: 2px;
      font-size: 10px;
      opacity: 0.85;
    }

    /* -------------------------------------------------------------
     * RESPONSIVE
     * ------------------------------------------------------------- */

    @media (max-width: 1100px) {
      .grid-main {
        grid-template-columns: minmax(0, 1fr);
      }
      .header-metrics {
        grid-template-columns: repeat(2, minmax(0, 1fr));
      }
    }

    @media (max-width: 800px) {
      .header-metrics {
        grid-template-columns: minmax(0, 1fr);
      }
      .topbar {
        flex-direction: column;
        align-items: flex-start;
      }
    }
  </style>
</head>

<body>
  <div class="page">
    <div class="page-bg"></div>
    <div class="page-overlay"></div>

    <div class="page-inner">
      <div class="dashboard-frame">

        <!-- ======================================================
             HEADER
             ====================================================== -->
        <header class="topbar">
          <div class="topbar-left">
            <div class="logo-dot"></div>
            <div>
              <div class="title-main">BOT GODMODE</div>
              <div id="status-profile-line" class="muted">
                Profil ‚Äì ‚Ä¢ source wallets : ‚Äì ‚Ä¢ snapshot : ‚Äì
              </div>
            </div>
            <span id="badge-profile" class="badge">M10 ‚Äì PAPER_ONCHAIN</span>
          </div>

          <div class="topbar-right">
            <small>
              API : <code>/godmode/status</code>,
              <code>/wallets/runtime</code>,
              <code>/alerts/finance</code>,
              <code>/trades/runtime</code>
            </small>

            <div class="refresh-row">
              <button id="refresh-all-btn" class="btn-refresh-main">
                <span class="btn-refresh-main-icon"></span>
                Rafra√Æchir maintenant
              </button>
              <span class="muted">Auto-refresh :</span>
              <button class="btn-pill" data-refresh-interval="15000">15 s</button>
              <button class="btn-pill active" data-refresh-interval="30000">30 s</button>
              <button class="btn-pill" data-refresh-interval="60000">60 s</button>
            </div>
          </div>
        </header>

        <!-- ======================================================
             HEADER METRICS
             ====================================================== -->
        <section class="header-metrics">
          <div class="metric-main">
            <div class="metric-main-label">Equity totale</div>
            <div id="metric-equity-total" class="metric-main-value">0,00 $US</div>
          </div>

          <div class="metric-secondary">
            <div class="metric-secondary-label">Pnl jour (wallets)</div>
            <div id="metric-pnl-wallets" class="metric-secondary-value">0,00 $US</div>
          </div>

          <div class="metric-secondary">
            <div class="metric-secondary-label">Mode live</div>
            <div class="metric-secondary-value">
              <span id="live-dot" class="live-dot off"></span>
              <span id="live-label" class="live-label">OFF (verrouill√© M10)</span>
            </div>
          </div>
        </section>

        <!-- ======================================================
             GRID PRINCIPALE
             ====================================================== -->
        <main class="grid-main">
          <!-- Colonne gauche -->
          <div class="grid-col">

            <!-- STATUT GLOBAL -->
            <section class="card">
              <div class="card-header">
                <div>
                  <div class="card-title">Statut global</div>
                  <div class="card-subtitle">
                    Source : <code>/godmode/status</code> ‚Ä¢ Profil risk &amp; safety LIVE_150
                  </div>
                </div>
                <div style="display:flex; gap:6px; align-items:center;">
                  <span id="pill-live-global" class="pill-small pill-live-off">LIVE BLOQU√â</span>
                  <span id="pill-killswitch" class="pill-small pill-killswitch-ok">KILLSWITCH OK</span>
                </div>
              </div>

              <pre id="status-json" class="status-json">{}</pre>

              <div class="status-footer">
                <div id="status-live-gate" class="muted">
                  ExecutionMode.LIVE verrouill√© tant que M10 n'est pas finalis√©.
                </div>
                <div style="min-width:130px; display:flex; flex-direction:column; gap:3px;">
                  <div class="status-bar"></div>
                  <div id="status-updated-at" class="muted td-right">Dernier refresh : ‚Äì</div>
                </div>
              </div>
            </section>

            <!-- TRADES RUNTIME -->
            <section class="card">
              <div class="card-header">
                <div>
                  <div class="card-title">Trades runtime</div>
                  <div class="card-subtitle">
                    Source : TradeStore JSONL ‚Ä¢ PnL jour consolid√© depuis wallets
                  </div>
                </div>
                <span id="trades-count-pill" class="badge-count">0 trades</span>
              </div>

              <div style="display:grid; grid-template-columns:repeat(3,minmax(0,1fr)); gap:8px; margin-bottom:6px; font-size:11px;">
                <div>
                  <div class="daily-label">Volume (all time)</div>
                  <div id="metric-trades-volume" class="daily-value">0,00 $US</div>
                </div>
                <div>
                  <div class="daily-label">Pnl jour (officiel)</div>
                  <div id="metric-trades-pnl" class="daily-value">0,00 $US</div>
                </div>
                <div>
                  <div class="daily-label">Fees (all time)</div>
                  <div id="metric-trades-fees" class="daily-value">0,00 $US</div>
                </div>
              </div>

              <div style="overflow:auto; max-height:250px;">
                <table>
                  <thead>
                    <tr>
                      <th>Heure</th>
                      <th>Chain</th>
                      <th>Coin</th>
                      <th>Pair</th>
                      <th class="td-center">Side</th>
                      <th class="td-right">Qty</th>
                      <th class="td-right">Price</th>
                      <th class="td-right">Notional ($)</th>
                      <th>Reason</th>
                    </tr>
                  </thead>
                  <tbody id="trades-table-body">
                    <!-- lignes inject√©es en JS -->
                  </tbody>
                </table>
              </div>

              <div class="status-footer" style="margin-top:6px;">
                <div class="muted">
                  Ces stats sont calcul√©es c√¥t√© front √† partir des trades les plus r√©cents.
                  La source de v√©rit√© PnL jour reste <code>wallets_runtime.json</code>.
                </div>
                <div id="trades-updated-at" class="muted td-right">Dernier refresh : ‚Äì</div>
              </div>
            </section>

            <!-- STAT JOUR - PNL PAR TRADE -->
            <section class="card">
              <div class="card-header">
                <div>
                  <div class="card-title">Stat jour ‚Äì PnL par trade (locale)</div>
                  <div class="card-subtitle">
                    Calcul√© c√¥t√© navigateur √† partir des trades dont la date est aujourd'hui.
                  </div>
                </div>
              </div>

              <div class="daily-grid">
                <div class="daily-item">
                  <div class="daily-label">Trades du jour</div>
                  <div id="daily-trades-count" class="daily-value">0</div>
                </div>
                <div class="daily-item">
                  <div class="daily-label">Volume du jour</div>
                  <div id="daily-volume" class="daily-value">0,00 $US</div>
                </div>
                <div class="daily-item">
                  <div class="daily-label">Winrate du jour</div>
                  <div id="daily-winrate" class="daily-value">‚Äì</div>
                </div>
                <div class="daily-item">
                  <div class="daily-label">Best / worst (jour)</div>
                  <div id="daily-bestworst" class="daily-value">‚Äì</div>
                </div>
              </div>
            </section>

          </div>

          <!-- Colonne droite -->
          <div class="grid-col">

            <!-- WALLETS RUNTIME -->
            <section class="card">
              <div class="card-header">
                <div>
                  <div class="card-title">Wallets runtime</div>
                  <div class="card-subtitle">
                    Snapshot <code>wallets_runtime.json</code> + policies M10
                  </div>
                </div>
                <span id="wallets-count-pill" class="badge-count">0 wallets</span>
              </div>

              <div style="display:grid; grid-template-columns:repeat(3,minmax(0,1fr)); gap:8px; margin-bottom:6px; font-size:11px;">
                <div>
                  <div class="daily-label">Equity totale</div>
                  <div id="wallets-equity-total" class="daily-value">0,00 $US</div>
                </div>
                <div>
                  <div class="daily-label">Pnl jour (runtime)</div>
                  <div id="wallets-pnl-day" class="daily-value">0,00 $US</div>
                </div>
                <div>
                  <div class="daily-label">Fees pay√©es (jour)</div>
                  <div id="wallets-fees-day" class="daily-value">0,00 $US</div>
                </div>
              </div>

              <div style="overflow:auto; max-height:220px;">
                <table>
                  <thead>
                    <tr>
                      <th>Wallet</th>
                      <th>Chain</th>
                      <th>R√¥le</th>
                      <th class="td-right">Balance ($)</th>
                      <th class="td-right">% Equity</th>
                      <th class="td-right">Pnl jour ($)</th>
                    </tr>
                  </thead>
                  <tbody id="wallets-table-body">
                    <!-- lignes inject√©es -->
                  </tbody>
                </table>
              </div>

              <div class="wallets-footer" id="wallets-fees-caps">
                Wallet fees : ‚Äì.
              </div>
            </section>

            <!-- ALERTES FINANCE -->
            <section class="card">
              <div class="card-header">
                <div>
                  <div class="card-title">Alertes finance</div>
                  <div class="card-subtitle">
                    Issues de <code>WalletFlowsEngine</code> + garde-fous M10
                  </div>
                </div>
                <span id="alerts-count-pill" class="badge-count">0 alerte</span>
              </div>

              <div id="alerts-empty" class="muted" style="margin-top:4px;">
                Aucune alerte finance.
              </div>
              <div id="alerts-list" class="alerts-list"></div>
            </section>

          </div>
        </main>

      </div>
    </div>
  </div>

  <!-- ============================================================
       SCRIPT
       ============================================================ -->
  <script>
    const REFRESH_DEFAULT = 30000;
    let refreshIntervalMs = REFRESH_DEFAULT;
    let refreshTimer = null;
    let latestTrades = [];

    function setText(id, value) {
      const el = document.getElementById(id);
      if (el) el.textContent = value;
    }

    function formatUsd(value, signed) {
      const num = Number(value) || 0;
      const abs = Math.abs(num).toFixed(2).replace(".", ",");
      const sign = signed ? (num > 0 ? "+" : num < 0 ? "-" : "") : "";
      return sign + abs + " $US";
    }

    function formatPercent(x) {
      if (x === null || x === undefined || isNaN(Number(x))) return "0,00 %";
      const v = Number(x) * 100;
      return v.toFixed(2).replace(".", ",") + " %";
    }

    function formatDateTime(iso) {
      if (!iso) return "‚Äì";
      const d = new Date(iso);
      if (isNaN(d.getTime())) return iso;
      return d.toLocaleString();
    }

    function formatTime(iso) {
      if (!iso) return "-";
      const d = new Date(iso);
      if (isNaN(d.getTime())) return "-";
      return d.toLocaleTimeString(undefined, { hour: "2-digit", minute: "2-digit", second: "2-digit" });
    }

    async function fetchJson(path) {
      const resp = await fetch(path);
      if (!resp.ok) {
        throw new Error(path + " -> HTTP " + resp.status);
      }
      return resp.json();
    }

    /* -----------------------------------------------------------
     * STATUS
     * ----------------------------------------------------------- */
    async function refreshStatus() {
      try {
        const data = await fetchJson("/godmode/status");

        setText("metric-equity-total", formatUsd(data.equity_total_usd, false));
        setText("metric-pnl-wallets", formatUsd(data.pnl_today_total_usd, true));

        const liveAllowed = !!data.live_allowed;
        const liveDot = document.getElementById("live-dot");
        if (liveDot) {
          liveDot.classList.toggle("on", liveAllowed);
          liveDot.classList.toggle("off", !liveAllowed);
        }
        setText(
          "live-label",
          liveAllowed ? "ON (autoris√©)" : "OFF (verrouill√© M10)"
        );

        const profileId = data.profile_id || "UNKNOWN";
        const walletsSource = data.wallets_source || "runtime";
        setText(
          "status-profile-line",
          "Profil " + profileId +
          " ‚Ä¢ source wallets : " + walletsSource +
          " ‚Ä¢ snapshot : " + formatDateTime(data.updated_at)
        );

        // Badge M10 + run_mode si dispo
        const badge = document.getElementById("badge-profile");
        if (badge) {
          const exec = data.execution || {};
          const runMode = (exec.run_mode || exec.execution_mode || "UNKNOWN").toUpperCase();
          badge.textContent = "M10 ‚Äì " + runMode;
        }

        // JSON light pour debug
        const jsonLight = {
          profile_id: data.profile_id,
          wallets_source: data.wallets_source,
          equity_total_usd: data.equity_total_usd,
          pnl_today_total_usd: data.pnl_today_total_usd,
          pnl_today_gross_usd: data.pnl_today_gross_usd,
          fees_paid_today_total_usd: data.fees_paid_today_total_usd,
          live_allowed: data.live_allowed,
          live_blocked_reasons: data.live_blocked_reasons,
          execution: data.execution,
          profile_state: data.profile_state,
        };
        const pre = document.getElementById("status-json");
        if (pre) {
          pre.textContent = JSON.stringify(jsonLight, null, 2);
        }

        // Gate LIVE
        const reasons = data.live_blocked_reasons || [];
        const gateEl = document.getElementById("status-live-gate");
        if (gateEl) {
          if (liveAllowed) {
            gateEl.textContent =
              "ExecutionMode.LIVE autoris√© (aucun garde-fou bloquant).";
          } else if (reasons.length) {
            gateEl.textContent =
              "ExecutionMode.LIVE verrouill√© : " + reasons.join(" ¬∑ ");
          } else {
            gateEl.textContent =
              "ExecutionMode.LIVE verrouill√© tant que M10 n'est pas finalis√©.";
          }
        }

        // Pills LIVE / killswitch
        const pillLive = document.getElementById("pill-live-global");
        if (pillLive) {
          pillLive.textContent = liveAllowed ? "LIVE AUTORIS√â" : "LIVE BLOQU√â";
          pillLive.classList.toggle("pill-live-off", !liveAllowed);
        }

        // Killswitch d'apr√®s execution
        const pillKs = document.getElementById("pill-killswitch");
        if (pillKs) {
          const kill = (data.execution && data.execution.kill_switch) || {};
          const ksOn = !kill.tripped;
          pillKs.textContent = ksOn ? "KILLSWITCH OK" : "KILLSWITCH TRIPPED";
        }

        setText(
          "status-updated-at",
          "Dernier refresh : " + formatDateTime(data.updated_at)
        );
      } catch (err) {
        console.error("refreshStatus error", err);
      }
    }

    /* -----------------------------------------------------------
     * WALLETS RUNTIME
     * ----------------------------------------------------------- */
    async function refreshWallets() {
      try {
        const data = await fetchJson("/godmode/wallets/runtime");

        const summary = data.summary || {};
        const finance = data.finance || {};
        const wallets = data.wallets || [];

        const totalWallets = summary.total_wallets || wallets.length;
        setText("wallets-count-pill", totalWallets + " wallets");

        setText(
          "wallets-equity-total",
          formatUsd(finance.equity_total_usd, false)
        );
        setText(
          "wallets-pnl-day",
          formatUsd(finance.pnl_today_total_usd, true)
        );
        setText(
          "wallets-fees-day",
          formatUsd(finance.fees_paid_today_total_usd, false)
        );

        const tbody = document.getElementById("wallets-table-body");
        if (tbody) {
          tbody.innerHTML = "";
          const wStates = (finance.wallets_state) || {};

          wallets.forEach(function (w) {
            const id = String(w.wallet_id || w.id || "").trim();
            const st = wStates[id] || {};
            const row = document.createElement("tr");

            const eq = st.equity_usd !== undefined ? st.equity_usd : w.equity_usd || w.balance_usd;
            const pnlDay =
              st.realized_pnl_today_usd !== undefined
                ? st.realized_pnl_today_usd
                : w.realized_pnl_today_usd || w.pnl_today_usd;

            const c1 = document.createElement("td");
            c1.textContent = id || "-";

            const c2 = document.createElement("td");
            c2.textContent = st.chain || w.chain || w.network || "-";

            const c3 = document.createElement("td");
            c3.textContent = st.role || w.role || "OTHER";

            const c4 = document.createElement("td");
            c4.className = "td-right";
            c4.textContent = formatUsd(eq, false);

            const c5 = document.createElement("td");
            c5.className = "td-right";
            c5.textContent = formatPercent(st.equity_pct);

            const c6 = document.createElement("td");
            c6.className = "td-right";
            c6.textContent = formatUsd(pnlDay, true);

            row.appendChild(c1);
            row.appendChild(c2);
            row.appendChild(c3);
            row.appendChild(c4);
            row.appendChild(c5);
            row.appendChild(c6);
            tbody.appendChild(row);
          });
        }

        // Wallet fees & caps r√©sum√©
        const feesState = finance.fees_wallet || null;
        const wfEl = document.getElementById("wallets-fees-caps");
        if (wfEl && feesState) {
          const bal = Number(feesState.balance_usd || 0);
          const pct = Number(feesState.equity_pct || 0);
          const minBuf = Number(feesState.min_buffer_usd || 0);
          const maxPct = Number(feesState.max_equity_pct || 0);
          wfEl.innerHTML =
            'Wallet fees = <strong>' + (feesState.id || "fees") +
            "</strong> ‚Ä¢ balance " + formatUsd(bal, false) +
            " (" + formatPercent(pct) + "). " +
            "Buffer min = " + formatUsd(minBuf, false) +
            ", cap = " + formatPercent(maxPct) + ".";
        } else if (wfEl) {
          wfEl.textContent = "Wallet fees : aucune info (fees_wallet non trouv√©).";
        }
      } catch (err) {
        console.error("refreshWallets error", err);
      }
    }

    /* -----------------------------------------------------------
     * ALERTES FINANCE
     * ----------------------------------------------------------- */
    async function refreshAlerts() {
      try {
        const data = await fetchJson("/godmode/alerts/finance");
        const alerts = data.alerts || [];
        const count = alerts.length;

        setText(
          "alerts-count-pill",
          count + (count <= 1 ? " alerte" : " alertes")
        );

        const empty = document.getElementById("alerts-empty");
        const list = document.getElementById("alerts-list");

        if (count === 0) {
          if (empty) empty.style.display = "block";
          if (list) list.innerHTML = "";
          return;
        }

        if (empty) empty.style.display = "none";
        if (!list) return;

        list.innerHTML = "";
        alerts.forEach(function (a) {
          const lvl = (a.level || "").toUpperCase();
          const item = document.createElement("div");
          item.className = "alert-item " +
            (lvl === "CRITICAL"
              ? "alert-lvl-critical"
              : lvl === "WARNING"
              ? "alert-lvl-warning"
              : "");

          const code = document.createElement("div");
          code.className = "alert-code";
          code.textContent = "[" + (lvl || "INFO") + "] " + (a.code || "UNKNOWN");

          const msg = document.createElement("div");
          msg.className = "alert-msg";
          msg.textContent = a.msg || "";

          const meta = document.createElement("div");
          meta.className = "alert-meta";
          const parts = [];
          if (a.wallet_id) parts.push("wallet: " + a.wallet_id);
          if (a.reason) parts.push("reason: " + a.reason);
          meta.textContent = parts.join(" ‚Ä¢ ");

          item.appendChild(code);
          if (msg.textContent) item.appendChild(msg);
          if (meta.textContent) item.appendChild(meta);
          list.appendChild(item);
        });
      } catch (err) {
        console.error("refreshAlerts error", err);
      }
    }

    /* -----------------------------------------------------------
     * TRADES RUNTIME + STAT JOUR
     * ----------------------------------------------------------- */
    async function refreshTrades() {
      try {
        const data = await fetchJson("/godmode/trades/runtime?limit=50");
        const trades = data.trades || [];
        latestTrades = trades.slice(); // pour la stat jour

        const tradeCount = data.trade_count || trades.length || 0;
        setText("trades-count-pill", tradeCount + " trades");

        setText("metric-trades-volume", formatUsd(data.volume_usd, false));
        setText("metric-trades-fees", formatUsd(data.fees_total_usd, false));
        // PnL officiel (vient des wallets)
        const pnlOfficial = data.pnl_realized_usd != null
          ? data.pnl_realized_usd
          : data.pnl_total_usd;
        setText("metric-trades-pnl", formatUsd(pnlOfficial, true));

        setText(
          "trades-updated-at",
          "Dernier refresh : " + formatDateTime(data.updated_at)
        );

        renderTradesTable(trades);
        renderDailyStats(trades);
      } catch (err) {
        console.error("refreshTrades error", err);
      }
    }

    function renderTradesTable(trades) {
      const tbody = document.getElementById("trades-table-body");
      if (!tbody) return;
      tbody.innerHTML = "";

      trades.forEach(function (t) {
        const row = document.createElement("tr");

        const ts = document.createElement("td");
        ts.textContent = formatTime(t.ts || t.created_at);
        row.appendChild(ts);

        const chain = document.createElement("td");
        chain.textContent = t.chain || (t.meta && t.meta.chain) || "-";
        row.appendChild(chain);

        const coin = document.createElement("td");
        let symbol = t.symbol || (t.meta && t.meta.symbol) || "";
        let coinTxt = "-";
        if (symbol && typeof symbol === "string") {
          coinTxt = symbol.split("/")[0] || symbol;
        }
        coin.textContent = coinTxt;
        row.appendChild(coin);

        const pair = document.createElement("td");
        pair.textContent = symbol || "-";
        row.appendChild(pair);

        const side = document.createElement("td");
        side.className = "td-center";
        const tag = document.createElement("span");
        const s = (t.side || "").toString().toUpperCase();
        tag.textContent = s || "-";
        tag.className =
          s === "SELL" ? "tag-side-sell" : s === "BUY" ? "tag-side-buy" : "";
        side.appendChild(tag);
        row.appendChild(side);

        const qty = document.createElement("td");
        qty.className = "td-right";
        qty.textContent =
          t.qty != null ? Number(t.qty).toFixed(3).replace(".", ",") : "-";
        row.appendChild(qty);

        const price = document.createElement("td");
        price.className = "td-right";
        price.textContent =
          t.price != null ? Number(t.price).toFixed(4).replace(".", ",") : "-";
        row.appendChild(price);

        const notional = document.createElement("td");
        notional.className = "td-right";
        let notVal = t.notional_usd;
        if (notVal == null && t.qty != null && t.price != null) {
          notVal = Number(t.qty) * Number(t.price);
        }
        notional.textContent = notVal != null
          ? formatUsd(notVal, false)
          : "0,00 $US";
        row.appendChild(notional);

        const reason = document.createElement("td");
        let r = t.reason || "-";
        if (r.length > 70) r = r.slice(0, 67) + "...";
        reason.textContent = r;
        row.appendChild(reason);

        tbody.appendChild(row);
      });
    }

    function renderDailyStats(trades) {
      const today = new Date();
      const keyToday = today.toISOString().slice(0, 10);

      let count = 0;
      let vol = 0;
      let wins = 0;
      let best = null;
      let worst = null;

      trades.forEach(function (t) {
        const iso = t.ts || t.created_at;
        if (!iso) return;
        const d = new Date(iso);
        if (isNaN(d.getTime())) return;
        if (d.toISOString().slice(0, 10) !== keyToday) return;

        count += 1;

        let notVal = t.notional_usd;
        if (notVal == null && t.qty != null && t.price != null) {
          notVal = Number(t.qty) * Number(t.price);
        }
        if (notVal != null) vol += Number(notVal);

        const pnl = Number(
          t.pnl_usd != null ? t.pnl_usd : t.pnl_sim_usd
        );
        if (!isNaN(pnl)) {
          if (pnl > 0) wins += 1;
          if (best === null || pnl > best) best = pnl;
          if (worst === null || pnl < worst) worst = pnl;
        }
      });

      setText("daily-trades-count", String(count));
      setText("daily-volume", formatUsd(vol, false));

      const winrateEl = document.getElementById("daily-winrate");
      if (count > 0) {
        const wr = (wins / count) * 100;
        if (winrateEl) winrateEl.textContent = wr.toFixed(1).replace(".", ",") + " %";
      } else if (winrateEl) {
        winrateEl.textContent = "‚Äì";
      }

      const bestWorstEl = document.getElementById("daily-bestworst");
      if (bestWorstEl) {
        if (best === null && worst === null) {
          bestWorstEl.textContent = "‚Äì";
        } else {
          const bestStr = best !== null ? formatUsd(best, true) : "‚Äì";
          const worstStr = worst !== null ? formatUsd(worst, true) : "‚Äì";
          bestWorstEl.textContent = bestStr + " / " + worstStr;
          bestWorstEl.classList.remove("positive", "negative");
          if (best !== null && best > 0) {
            bestWorstEl.classList.add("positive");
          }
          if (worst !== null && worst < 0) {
            bestWorstEl.classList.add("negative");
          }
        }
      }
    }

    /* -----------------------------------------------------------
     * AUTO-REFRESH
     * ----------------------------------------------------------- */
    function startAutoRefresh() {
      if (refreshTimer) {
        clearInterval(refreshTimer);
        refreshTimer = null;
      }
      if (refreshIntervalMs > 0) {
        refreshTimer = setInterval(refreshAll, refreshIntervalMs);
      }
    }

    function setupRefreshControls() {
      const btnMain = document.getElementById("refresh-all-btn");
      if (btnMain) {
        btnMain.addEventListener("click", function () {
          refreshAll();
        });
      }

      const btns = document.querySelectorAll("[data-refresh-interval]");
      btns.forEach(function (btn) {
        btn.addEventListener("click", function () {
          const ms = Number(btn.getAttribute("data-refresh-interval")) || REFRESH_DEFAULT;
          refreshIntervalMs = ms;
          btns.forEach(function (b) { b.classList.remove("active"); });
          btn.classList.add("active");
          startAutoRefresh();
        });
      });
    }

    async function refreshAll() {
      await Promise.all([
        refreshStatus(),
        refreshWallets(),
        refreshAlerts(),
        refreshTrades(),
      ]);
    }

    document.addEventListener("DOMContentLoaded", function () {
      setupRefreshControls();
      refreshAll();
      startAutoRefresh();
    });
  </script>
</body>
</html>

